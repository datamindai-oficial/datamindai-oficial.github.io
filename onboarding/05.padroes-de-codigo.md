---
title: Padrões de Código & Arquitetura
parent: Playbook
nav_order: 3
---

# Padrões de Código & Arquitetura

> **Objetivo:** garantir consistência, legibilidade e evolução segura dos serviços e aplicações.  
> **Escopo:** convenções para Python/TypeScript, estrutura de projeto, tratamento de erros/logs, testes, dependências e diretrizes de API.

---

## Sumário
- [Padrões de Código \& Arquitetura](#padrões-de-código--arquitetura)
  - [Sumário](#sumário)
  - [Princípios](#princípios)
  - [Convenções gerais](#convenções-gerais)
  - [Python — guias práticos](#python--guias-práticos)
  - [TypeScript — guias práticos](#typescript--guias-práticos)
  - [Estrutura de projeto](#estrutura-de-projeto)
  - [Erros, logs e observabilidade](#erros-logs-e-observabilidade)
  - [Testes](#testes)
  - [Dependências \& segurança](#dependências--segurança)
  - [APIs (REST/HTTP)](#apis-resthttp)
  - [Versão, migrações e compatibilidade](#versão-migrações-e-compatibilidade)
  - [Checklists](#checklists)
    - [Antes de abrir PR](#antes-de-abrir-pr)
    - [Antes de deploy](#antes-de-deploy)

---

## Princípios
- **Clareza sobre esperteza:** prefira o simples e explícito.
- **Coesão alta, acoplamento baixo:** módulos com responsabilidades claras.
- **Código auditável:** log estruturado, decisões registradas.
- **Evolução incremental:** pequenas PRs, testes e migrações seguras.
- **Paridade de ambientes:** o que roda localmente deve rodar no CI/prod (mesmos artefatos/locks).

---

## Convenções gerais
- **Naming**: `snake_case` para arquivos Python, `kebab-case` para pastas; em TS, arquivos `kebab-case.ts(x)`.
- **Comentários**: explique **por que**, não **o quê**. Prefira docstrings/JsDoc a comentários soltos.
- **Tamanho de função**: até ~30–40 linhas; extraia helpers.
- **Side effects**: evite em módulos; use funções/objetos puros quando possível.
- **I/O e boundary**: isole chamadas externas (HTTP/DB) em adaptadores; facilite mocks em teste.
- **Config**: por variável de ambiente (12-factor); default seguro e validar no boot.

---

## Python — guias práticos
- **Formatação & Lint**: `ruff` (lint/format) e `black` (opcional se não usar ruff format).  
- **Typing**: obrigatório em **funções públicas** e camadas de domínio; `from __future__ import annotations` em 3.11-.
- **Imports**: `stdlib` → `third-party` → `local` (linhas em branco entre grupos).
- **Estrutura de pacotes**: `src/<app>/` com `__init__.py` explícito.
- **Erros**: crie hierarquia `AppError(Exception)` e tipos específicos; não engula exceções.
- **CLI e scripts**: use `if __name__ == "__main__":` e `argparse`/`typer`.

**Exemplo (Python):**
```python
from dataclasses import dataclass
from typing import Iterable

class AppError(Exception):
    """Erro base da aplicação."""

class UserNotFound(AppError):
    pass

@dataclass(frozen=True)
class User:
    id: str
    email: str

def find_user(ids: Iterable[str]) -> list[User]:
    # regra de negócio aqui
    return [User(id=i, email=f"{i}@example.com") for i in ids]
```

**Config por env (pydantic/attrs opcional):**
```python
import os

class Settings:
    def __init__(self) -> None:
        self.env = os.getenv("APP_ENV", "dev")
        self.db_url = os.environ["DB_URL"]  # falha rápido

settings = Settings()
```

**pyproject.toml (trecho):**
```toml
[tool.ruff]
line-length = 100
target-version = "py312"

[tool.ruff.lint]
select = ["E", "F", "I", "UP", "B", "SIM"]

[tool.pytest.ini_options]
testpaths = ["tests"]
addopts = "-q"
```

---

## TypeScript — guias práticos
- **Strict mode**: `"strict": true` no `tsconfig.json`.
- **Módulos**: ES Modules; evitar `any`; use `unknown` + narrowing.
- **Arquitetura**: separação **domínio** / **infra** / **adapters** / **ui**.
- **Erros**: `Result`/`Either` ou exceções padronizadas; log estruturado.
- **React**: componentes puros, props tipadas; evitar lógica pesada no render.

**Exemplo (TypeScript):**
```ts
export type User = { id: string; email: string };

export function findUser(ids: string[]): User[] {
  return ids.map((id) => ({ id, email: `${id}@example.com` }));
}
```

`tsconfig.json` (trecho):
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "strict": true,
    "noImplicitAny": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true
  }
}
```

---

## Estrutura de projeto
**Python (app de serviços):**
```
repo/
├─ src/app/
│  ├─ domain/           # regras de negócio
│  ├─ adapters/         # http/db/cache/emails
│  ├─ services/         # orquestração de casos de uso
│  ├─ __init__.py
├─ tests/
├─ pyproject.toml
└─ uv.lock
```

**TypeScript (api/web):**
```
repo/
├─ src/
│  ├─ domain/
│  ├─ infra/
│  ├─ adapters/
│  └─ ui/               # se web
├─ tests/
├─ package.json
└─ tsconfig.json
```

---

## Erros, logs e observabilidade
- **Erros**: levantar exceções específicas; nunca suprimir silenciosamente.  
- **Logs**: estruturados (JSON), com `trace_id`/`user_id` quando aplicável. Níveis: `debug` (dev), `info` (fluxo), `warn` (anomalias), `error` (falhas).  
- **Métricas**: tempo de resposta, taxa de erro, throughput.  
- **Tracing**: propagar `traceparent`/`baggage` (OpenTelemetry).  
- **Não logar segredos** ou dados sensíveis; mascarar PII.

**Exemplo de log (JSON):**
```json
{ "level":"info", "msg":"user created", "user_id":"u_123", "trace_id":"abc-xyz" }
```

---

## Testes
- **Piramide**: muitos unitários, menos integração, poucos end-to-end.  
- **Nomes claros**: `test_quando_XoY_entao_Z.py`.  
- **Fixtures**: reaproveite setup com `pytest` fixtures.  
- **Cobertura**: foque em **código crítico**; não persiga 100% cegamente.  
- **Contratos**: para integração entre serviços, use testes de contrato/mocks.

**Exemplo pytest:**
```python
def test_quando_ids_validos_entao_retorna_usuarios():
    out = find_user(["1", "2"])  # arrange/act
    assert len(out) == 2             # assert
```

---

## Dependências & segurança
- **Pin/lock**: `uv.lock`/`package-lock.json`; CI com `--frozen`/`ci`.
- **Review**: evite libs sem manutenção; prefira padrão da org.
- **Atualizações**: janelas quinzenais/mensais; automação (Dependabot).
- **SCA**: habilitar scan de vulnerabilidades no CI.
- **Licenças**: atenção a GPL/AGPL conforme política da empresa.

---

## APIs (REST/HTTP)
- **Versionar**: `/v1/...` no path; manter compatibilidade por período.
- **HTTP codes**: use 2xx/4xx/5xx corretamente; 422 para validação.
- **Contrato**: OpenAPI/Swagger fonte de verdade; gerar clientes/servidores quando possível.
- **Idempotência**: `PUT`/`DELETE` idempotentes; `POST` para criação.
- **Paginação**: `limit/offset` ou cursor; sempre documente limites.
- **Erro padrão**:
```json
{ "error": { "code": "USER_NOT_FOUND", "message": "User not found" } }
```

---

## Versão, migrações e compatibilidade
- **SemVer**: `MAJOR.MINOR.PATCH` para libs e APIs públicas.
- **Deprecações**: anunciar, marcar em docs e telemetria de uso.
- **Migrações de DB**: ferramentas (Alembic/Prisma); scripts reversíveis; rodar em `homolog` antes de `main`.

---

## Checklists

### Antes de abrir PR
- [ ] Lint/format OK
- [ ] Testes locais OK / cobertura mínima
- [ ] Logs e erros tratados
- [ ] Sem segredo no código
- [ ] Docstrings/README atualizados (se aplicável)

### Antes de deploy
- [ ] Configs por env conferidas
- [ ] Migrações aplicadas/testadas em homolog
- [ ] Observabilidade (dashboards/alertas) revisada
- [ ] Backout/rollback definido
