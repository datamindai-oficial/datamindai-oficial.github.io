---
title: CI/CD & Qualidade Mínima
parent: Playbook
nav_order: 2
---

# CI/CD & Qualidade Mínima

> **Objetivo:** padronizar um pipeline simples, rápido e confiável para qualquer repositório.  
> **Resultado esperado:** cada PR passa por **lint, testes e segurança**, produz **artefatos reprodutíveis** e só entra na `dev/homolog/main` quando os **checks obrigatórios** estiverem verdes.

---

## Sumário
- [CI/CD \& Qualidade Mínima](#cicd--qualidade-mínima)
  - [Sumário](#sumário)
  - [Principais conceitos](#principais-conceitos)
  - [Qualidade mínima (gates)](#qualidade-mínima-gates)
  - [Fluxo por branch/env](#fluxo-por-branchenv)
  - [Exemplo — GitHub Actions (Python + uv)](#exemplo--github-actions-python--uv)
    - [1) `.github/workflows/ci.yml` — CI em PR (qualidade mínima)](#1-githubworkflowsciyml--ci-em-pr-qualidade-mínima)
    - [2) `.github/workflows/deploy.yml` — build \& deploy por branch](#2-githubworkflowsdeployyml--build--deploy-por-branch)
  - [Boas práticas de performance](#boas-práticas-de-performance)
    - [Exemplo de cache (opcional)](#exemplo-de-cache-opcional)
  - [Segurança e segredos](#segurança-e-segredos)
  - [Políticas no GitHub](#políticas-no-github)
  - [Checklist de adoção](#checklist-de-adoção)

---

## Principais conceitos
- **CI** (Continuous Integration): valida a cada commit/PR (linters, testes, build).
- **CD** (Continuous Delivery/Deployment): entrega para ambientes (dev → homolog → main/prod).
- **Qualidade mínima (gates)**: conjunto de checks obrigatórios antes do merge/deploy.
- **Artefatos reprodutíveis**: pacotes/imagens gerados a partir do mesmo lockfile e build script.
- **Paridade de ambientes**: o que roda no CI é o que roda em prod (mesma imagem/mesmo `uv.lock`).

---

## Qualidade mínima (gates)
Os pipelines devem, no mínimo:
1. **Instalar dependências de forma reprodutível**  
   - `uv sync --frozen` (usa `uv.lock` do repositório).
2. **Checar estilo e erros comuns**  
   - `ruff check .` (lint) e `ruff format --check .` (formatação) ou `black --check .`.
3. **Executar testes**  
   - `pytest -q` com relatório de cobertura (ex.: `coverage xml`).
4. **Security & SCA**  
   - Scan de dependências (ex.: `pip-audit`/`safety`) e policy para CVEs críticos.
5. **Build** (se aplicável)  
   - Empacotar wheel/container **somente** em `main/homolog`.
6. **Artefatos**  
   - Publicar relatórios (lint/test/coverage) e build (wheel/imagem).
7. **Proteção de branch**  
   - Exigir **todos os checks** acima antes do merge.

---

## Fluxo por branch/env
```
feature/bugfix → dev → homolog → main
```
- **PR → `dev`**: roda *CI completo* (lint, testes, SCA).  
- **Merge `dev` → `homolog`**: roda build, publica **artefatos** e faz **deploy em homolog**.  
- **Merge `homolog` → `main`**: roda build final, **deploy em produção** com **ambiente protegido** (aprovadores).

> **Hotfix**: `hotfix/*` a partir de `main` com deploy controlado e posterior *back-merge* para `homolog` e `dev`.

---

## Exemplo — GitHub Actions (Python + uv)
Pipeline em 2 arquivos: **CI por PR** e **deploy por branch**. Ajuste nomes de jobs e políticas conforme seu repositório.

### 1) `.github/workflows/ci.yml` — CI em PR (qualidade mínima)
```yaml
name: CI
on:
  pull_request:
    branches: [ "dev" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Sync deps (frozen)
        run: uv sync --frozen

      - name: Lint (ruff)
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Tests
        run: uv run pytest -q

      - name: Coverage report (xml)
        run: |
          uv run coverage xml || true
          echo "Cobertura gerada (se configurado)"
```

### 2) `.github/workflows/deploy.yml` — build & deploy por branch
```yaml
name: Build & Deploy
on:
  push:
    branches: [ "homolog", "main" ]

env:
  IMAGE_NAME: ghcr.io/ORG/APP

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Login GHCR
        if: github.repository_owner == 'ORG'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          docker build -t $IMAGE_NAME:${{ github.ref_name }} .

      - name: Push image
        run: |
          docker push $IMAGE_NAME:${{ github.ref_name }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }} # "homolog" ou "main"
    steps:
      - name: Deploy step
        run: |
          echo "Faça o deploy usando seu script/CLI (kubectl, helm, serverless, etc)"
          echo "O ambiente '${{ github.ref_name }}' está protegido para aprovações."
```
> **Observação:** use **Environments** do GitHub (`Settings → Environments`) chamados `homolog` e `main` para exigir **aprovadores** e **segredos por ambiente**.

---

## Boas práticas de performance
- **Cache** do `uv` e `pip` entre jobs (GitHub Actions cache).  
- **Matrix** de versões só quando necessário (ex.: Python 3.11/3.12).  
- **Jobs paralelos** (lint/test separados) com dependências mínimas.  
- **Artefatos leves** (apenas relatórios e pacotes).  
- **Dependências dev vs runtime** separadas no `pyproject.toml`.

### Exemplo de cache (opcional)
```yaml
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
```

---

## Segurança e segredos
- **Nunca** hardcode segredos no repositório.  
- Use **Secrets/Environments** do GitHub para chaves e tokens.  
- **Principle of least privilege** nos provedores (roles por ambiente).  
- Scans de dependências e imagens (ex.: `pip-audit`, `trivy`) no pipeline.  
- Bloquear merge se houver **CVE crítica** sem justificativa.

---

## Políticas no GitHub
- **Branch protection** em `main` e `homolog`:
  - Require pull request reviews: **ON**
  - Require status checks to pass: **ON** (CI)
  - Require branches up to date: **ON**
  - Restrict who can push: **ON** para `main`
- **Environments**: `homolog` e `main` com **aprovadores** e **segredos** dedicados.
- **Actions permissions**: `Allow GitHub Actions to create and approve pull requests from workflows` **OFF**, a menos que justificado.
- **Dependabot/SCA** habilitados no repo.

---

## Checklist de adoção
- [ ] `uv.lock` no repositório e `uv sync --frozen` no CI
- [ ] Lint + format + tests obrigatórios em PRs para `dev`
- [ ] Build + publish de artefatos em `homolog`/`main`
- [ ] Environments (`homolog`, `main`) com aprovadores e segredos
- [ ] Branch protection configurado com status checks
- [ ] Scans de segurança habilitados (deps/imagem)
- [ ] Cache do CI configurado (se aplicável)
